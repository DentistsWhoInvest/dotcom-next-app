steps:
  - name: gcr.io/cloud-builders/npm
    id: install-deps
    args:
      - ci

  - name: gcr.io/cloud-builders/npm
    id: build-site
    secretEnv:
      - STRAPI_API_KEY
    env:
      - 'NEXT_ADMIN_STRAPI_URL=https://admin.dentistswhoinvest.com/api'
    args: ['run', 'build']

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: create-empty-directory
    entrypoint: bash
    args:
      - -c
      - mkdir -p ./empty

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: empty-bucket
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - ./empty/
      - gs://${_BUCKET}-staging
      - --recursive
      - --delete-unmatched-destination-objects

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: upload-html-files
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - ./out/
      - gs://${_BUCKET}-staging
      - --content-type=text/html
      - --exclude='.+\..*'
      - --recursive

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: upload-rest-of-site
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - ./out/
      - gs://${_BUCKET}-staging
      - --recursive

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: upload-public-assets
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - ./public/
      - gs://${_BUCKET}-staging/public/
      - --recursive

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: publish
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - gs://${_BUCKET}-staging/
      - gs://${_BUCKET}/
      - --recursive
      - --delete-unmatched-destination-objects

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: empty-bucket-again
    entrypoint: gcloud
    args:
      - storage
      - rsync
      - ./empty/
      - gs://${_BUCKET}-staging
      - --recursive
      - --delete-unmatched-destination-objects

options:
  logging: CLOUD_LOGGING_ONLY

# injected for each trigger, either dwi-dotcom-beta-static-assets or dwi-dotcom-static-assets
# substitutions:
  # _BUCKET: 

availableSecrets:
  secretManager:
    - versionName: projects/276123986162/secrets/STRAPI_TOKEN/versions/latest
      env: STRAPI_API_KEY
